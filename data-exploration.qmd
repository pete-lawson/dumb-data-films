---
author: Pete Lawson
format: html
---

## Scrape JHU titles from blog post

```{python}
import pandas as pd
import requests
from bs4 import BeautifulSoup
import duckdb
import re
```

Scrape page for details


```{python}
response = requests.get('https://hub.jhu.edu/2015/10/13/johns-hopkins-on-film/')
soup = BeautifulSoup(response.content, 'html.parser')
```


```{python}
print(soup.prettify())
```


```{python}
titles_raw = soup.find_all('em')
titles = []
# Iterate all titles except last (not a valid title)
for title in titles_raw[0:-1]:
    titles.extend(title.contents)
```


Get title ID

```{python}
con = duckdb.connect()
csv_data = con.read_csv('./data/title.akas.tsv')
```

```{python}
con.sql("DESCRIBE csv_data")
```

Query matching titles
```{python}
df = con.execute(
    """
    SELECT *
    FROM csv_data
    WHERE title IN (SELECT * FROM UNNEST(?))
""",
    [titles],
).fetchdf()
```

Questions:
- For TV shows, do we return an average rating across all seasons/episodes?
  

Get rotten tomato ratings:


```{python}
rt_scores = pd.read_csv('./data/movie_info.csv')
title_rt_scores = rt_scores[rt_scores['title'].isin(titles)]
```

Questions/Comments

- Many titles missing in Rotten Tomatoes scores.
- How do we disambiguate House of Cards show from 1968 movie.
  
Scrape rotten tomatoes for individual titles:


```{python}
response = requests.get('https://www.rottentomatoes.com/tv/house-of-cards')
soup = BeautifulSoup(response.content, 'html.parser')
```


```{python}
critics_score = soup.find("rt-text", attrs={"slot": "criticsScore", "role":"button"}).get_text(strip=True)

audience_score = soup.find("rt-text", attrs={"slot": "audienceScore", "role":"button"}).get_text(strip=True)
#print(soup.prettify())
```

Breadcrumbs:
- Turn scraper into function.
- Add TV or Movie to titles, as Rotten Tomatos URLs are either m or tv depending, i.e. https://www.rottentomatoes.com/tv/house_of_cards

```{python}

medium = ['m', 'm', 'tv', 'm', 'm', 'm', 'm', 'tv', 'm', 'tv', 'tv', 'm', 'm']
```

```{python}
# Call function
def url_constructor(title, medium):
    rt_title = re.sub(r"[^a-z0-9_]", "", title.lower().replace(" ", "_"))
    return f'https://www.rottentomatoes.com/{medium}/{rt_title}'

```

```{python}
rt_urls = []
for title, med in zip(titles, medium):
    url = url_constructor(title, med)
    rt_urls.append(url) 
```


```{python}
def get_rt_ratings(url):
    response = requests.get(url)
    soup = BeautifulSoup(response.content, 'html.parser')
    critics_score = soup.find("rt-text", attrs={"slot": "criticsScore", "role":"button"}).get_text(strip=True)
    audience_score = soup.find("rt-text", attrs={"slot": "audienceScore", "role":"button"}).get_text(strip=True)
    return {'critics': critics_score,'audience': audience_score}
```
